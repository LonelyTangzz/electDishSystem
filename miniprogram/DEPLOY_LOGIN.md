# 登录功能部署指南

## 快速开始

### 第一步：部署云函数

1. 打开微信开发者工具
2. 在项目中找到 `cloudfunctions/login` 文件夹
3. 右键点击 `login` 文件夹
4. 选择 **"上传并部署：云端安装依赖"**
5. 等待部署完成

### 第二步：配置云数据库

1. 打开[微信云开发控制台](https://console.cloud.tencent.com/tcb)
2. 进入你的环境
3. 点击 **"数据库"**
4. 创建一个名为 `users` 的集合
5. 设置权限为：**"仅创建者可读写"**

权限配置JSON（可选）：
```json
{
  "read": "doc._openid == auth.openid",
  "write": "doc._openid == auth.openid"
}
```

### 第三步：验证部署

1. 在微信开发者工具中点击 **"编译"**
2. 小程序会自动启动并执行登录流程
3. 查看控制台输出：
   - ✅ 看到 "云开发初始化成功" 
   - ✅ 看到 "登录完成"
   - ✅ 有 OpenID 信息

4. 点击底部 **"我的"** 标签
5. 点击 **"微信授权登录"** 按钮
6. 允许授权后，应该能看到你的头像和昵称

### 第四步：真机测试

1. 点击开发者工具右上角 **"预览"**
2. 使用微信扫码
3. 在真机上测试登录流程
4. 确认功能正常

## 常见问题

### Q1: 提示 "云开发暂未开通"

**A:** 
1. 检查 `app.js` 中的环境ID是否正确
2. 确保已在微信公众平台开通云开发
3. 如果还未开通，会自动使用Demo模式（本地数据）

### Q2: 点击登录按钮没反应

**A:**
1. 确保在真机上测试（开发者工具的授权有限制）
2. 检查微信版本是否 ≥ 6.5.3
3. 检查基础库版本是否 ≥ 2.10.4

### Q3: 用户信息无法保存到数据库

**A:**
1. 检查云数据库 `users` 集合是否已创建
2. 检查权限配置是否正确
3. 查看云函数日志是否有错误

### Q4: 如何在开发阶段测试？

**A:**
- 系统支持Demo模式，即使没有云开发也能测试所有功能
- 数据会保存在本地存储中
- 页面右下方会显示 "💡 当前为Demo模式"

## 环境ID配置

如果你的云开发环境ID不是默认的，需要修改 `app.js`：

```javascript
wx.cloud.init({
  env: 'your-env-id', // 改成你的环境ID
  traceUser: true
});
```

查找环境ID：
1. 打开[微信云开发控制台](https://console.cloud.tencent.com/tcb)
2. 在顶部可以看到环境名称和ID
3. 复制环境ID到代码中

## 测试清单

部署完成后，请确认以下功能：

- [ ] 小程序启动后能自动获取OpenID
- [ ] "我的"页面显示登录按钮
- [ ] 点击登录按钮能弹出授权窗口
- [ ] 授权后能显示用户头像和昵称
- [ ] 用户信息保存到数据库（云开发模式）或本地（Demo模式）
- [ ] 关闭小程序重新打开，用户信息仍然存在
- [ ] 点击"退出登录"能清除用户信息
- [ ] 退出后重新登录能正常授权

## 下一步

登录功能部署完成后，你可以：

1. 在订单页面添加登录检查
2. 实现个性化推荐功能
3. 添加用户积分系统
4. 实现用户评价功能

详细开发文档请参考 [LOGIN_GUIDE.md](./LOGIN_GUIDE.md)

## 技术支持

如果遇到问题：
1. 查看控制台错误信息
2. 检查云函数日志
3. 参考 [LOGIN_GUIDE.md](./LOGIN_GUIDE.md)
4. 查看微信小程序[官方文档](https://developers.weixin.qq.com/miniprogram/dev/framework/)

