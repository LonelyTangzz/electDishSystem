# 微信登录测试指南 - 真机调试

## 🔧 问题修复说明

已修复的问题：
1. ✅ 退出登录时未清除本地缓存
2. ✅ 增加了详细的调试日志
3. ✅ 改进了错误提示

## 📱 完整测试步骤

### 第一步：重新编译

在**微信开发者工具**中：

1. **清除缓存**
   - 点击菜单 **"工具"** → **"清除缓存"** → **"清除所有缓存"**

2. **重新编译**
   - 点击 **"编译"** 按钮

3. **真机预览**
   - 点击 **"预览"** 按钮
   - 用微信扫码

### 第二步：退出登录（清除旧数据）

在**手机上**：

1. **打开小程序**
2. **点击底部"我的"标签**
3. **向下滚动**
4. **找到并点击 "🚪 退出登录"**
5. **确认退出**
6. **应该看到提示 "已退出登录"**

### 第三步：重新授权登录

现在页面应该显示登录界面：

```
┌─────────────────────┐
│      👤             │
│  欢迎来到阿汤的小食堂  │
│ 登录后可查看订单历史   │
│                     │
│  🔐 微信授权登录     │  ← 点击这里
└─────────────────────┘
```

1. **点击 "🔐 微信授权登录" 按钮**
2. **会弹出微信授权窗口**：

```
┌─────────────────────────┐
│ 阿汤的小食堂             │
│ 申请获取以下权限：        │
│                         │
│ • 你的公开信息           │
│   （昵称、头像等）        │
│                         │
│  [拒绝]      [允许]      │  ← 点击"允许"
└─────────────────────────┘
```

3. **点击 "允许"**
4. **完成！**

### 第四步：验证结果

授权成功后，应该看到：

```
┌─────────────────────┐
│  [你的真实头像]       │
│   你的真实昵称        │  ← 这里应该显示你的微信昵称
│  欢迎来到阿汤的小食堂  │
├─────────────────────┤
│  0 待完成 | 0 已完成 │
└─────────────────────┘
```

## 📊 查看调试日志

### 在开发者工具中查看真机日志

1. **保持手机和电脑在同一网络**
2. **在开发者工具中点击"调试器"**
3. **选择"真机调试"**
4. **查看 Console 输出**

### 关键日志信息

**授权成功时应该看到：**

```
===== 开始获取用户信息 =====
🔐 调用 wx.getUserProfile
✅ 支持 getUserProfile，开始调用...
✅ wx.getUserProfile 调用成功: {...}
📝 用户信息: {nickName: "你的昵称", avatarUrl: "头像URL"}
💾 开始保存用户信息: 你的昵称
✅ 已保存到全局数据
✅ 已保存到本地存储
☁️ 保存到云数据库, OpenID: xxx
✅ 获取用户信息成功: {...}
```

**退出登录时应该看到：**

```
🚪 开始退出登录...
✅ 已清除全局用户数据
✅ 已清除本地存储
已退出登录
```

**如果用户拒绝授权：**

```
❌ wx.getUserProfile 调用失败: {errMsg: "getUserProfile:fail cancel"}
您取消了授权
```

## ❓ 常见问题排查

### Q1: 点击授权按钮后没有弹出窗口

**可能原因：**
- 微信版本过低
- 已经授权过，系统直接使用了缓存

**解决方法：**
1. 确保微信版本 ≥ 8.0.0
2. 先点击"退出登录"清除缓存
3. 重新点击授权

### Q2: 显示"您取消了授权"

**原因：**
- 你在授权窗口中点击了"拒绝"或返回键

**解决方法：**
- 重新点击"微信授权登录"
- 在弹窗中点击"允许"

### Q3: 还是显示"微信用户"

**可能原因：**
- 本地缓存未清除
- 授权失败但有旧缓存

**解决方法：**
1. 删除手机上的小程序
2. 重新扫码打开
3. 进入"我的"页面
4. 点击"微信授权登录"

### Q4: 授权后立即显示"微信用户"

**可能原因：**
- `wx.getUserProfile` API 调用失败
- 查看控制台的错误日志

**解决方法：**
1. 查看真机调试日志
2. 找到具体错误信息
3. 根据错误信息解决

## 🔍 调试技巧

### 开启真机调试

1. 在开发者工具中点击 **"真机调试"**
2. 用手机扫码
3. 可以在开发者工具的 Console 中看到手机的日志

### 手机端查看日志

**方法一：vConsole（推荐）**

在 `app.json` 中添加：
```json
{
  "debug": true
}
```

重新编译后，手机上会显示一个绿色的 vConsole 按钮，点击可以查看日志。

**方法二：真机调试**
- 保持手机和电脑在同一网络
- 使用"真机调试"功能
- 在开发者工具中查看日志

## ✅ 成功标志

完全成功后，你应该：

1. ✅ 看到自己真实的微信头像
2. ✅ 看到自己真实的微信昵称
3. ✅ 控制台显示 "✅ 获取用户信息成功"
4. ✅ 退出登录后能清除所有数据
5. ✅ 重新授权能获取最新信息

## 📞 需要帮助？

如果还是不行，请提供：

1. **控制台的完整日志**（特别是包含 🔐 和 ✅/❌ 的日志）
2. **手机微信版本**
3. **出现的错误提示**
4. **授权窗口是否弹出**

这样我可以更准确地帮你诊断问题！

---

**最后更新：** 2025-12-01
**状态：** ✅ 已优化和增强日志

